import { ComponentFixture, TestBed } from '@angular/core/testing';
import { provideZonelessChangeDetection } from '@angular/core';
import { ArticleGenerationComponent } from './article-generation.component';

describe('ArticleGenerationComponent', () => {
  let component: ArticleGenerationComponent;
  let fixture: ComponentFixture<ArticleGenerationComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [ArticleGenerationComponent],
      providers: [provideZonelessChangeDetection()]
    }).compileComponents();

    fixture = TestBed.createComponent(ArticleGenerationComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('devrait Ãªtre crÃ©Ã©', () => {
    expect(component).toBeTruthy();
  });

  describe('onGenerate()', () => {
    it('devrait Ã©mettre l\'Ã©vÃ©nement generate', () => {
      let emitted = false;
      component.generate.subscribe(() => emitted = true);
      
      component.onGenerate();
      
      expect(emitted).toBe(true);
    });

    it('devrait Ã©mettre l\'Ã©vÃ©nement generate mÃªme si appelÃ© plusieurs fois', () => {
      let callCount = 0;
      component.generate.subscribe(() => callCount++);
      
      component.onGenerate();
      component.onGenerate();
      
      expect(callCount).toBe(2);
    });

    it('devrait Ã©mettre l\'Ã©vÃ©nement generate sans paramÃ¨tres', () => {
      let emitted = false;
      component.generate.subscribe(() => emitted = true);
      
      component.onGenerate();
      
      expect(emitted).toBe(true);
    });

    it('devrait fonctionner avec des appels rapides', () => {
      let callCount = 0;
      component.generate.subscribe(() => callCount++);
      
      // Appels rapides successifs
      for (let i = 0; i < 5; i++) {
        component.onGenerate();
      }
      
      expect(callCount).toBe(5);
    });

    it('devrait Ãªtre une mÃ©thode pure sans effets de bord', () => {
      let generateEmitted = false;
      let changeEmitted = false;
      component.generate.subscribe(() => generateEmitted = true);
      component.articleIdeaChange.subscribe(() => changeEmitted = true);
      
      component.onGenerate();
      
      expect(generateEmitted).toBe(true);
      expect(changeEmitted).toBe(false);
    });
  });

  describe('onArticleIdeaChange(value: string)', () => {
    it('devrait Ã©mettre l\'Ã©vÃ©nement articleIdeaChange avec la valeur fournie', () => {
      const testValue = 'Comment planter des roses';
      let emittedValue = '';
      component.articleIdeaChange.subscribe(value => emittedValue = value);
      
      component.onArticleIdeaChange(testValue);
      
      expect(emittedValue).toBe(testValue);
    });

    it('devrait Ã©mettre une chaÃ®ne vide', () => {
      let emittedValue = 'not empty';
      component.articleIdeaChange.subscribe(value => emittedValue = value);
      
      component.onArticleIdeaChange('');
      
      expect(emittedValue).toBe('');
    });

    it('devrait Ã©mettre une valeur avec des espaces', () => {
      const testValue = '  IdÃ©e avec espaces  ';
      let emittedValue = '';
      component.articleIdeaChange.subscribe(value => emittedValue = value);
      
      component.onArticleIdeaChange(testValue);
      
      expect(emittedValue).toBe(testValue);
    });

    it('devrait gÃ©rer les valeurs longues', () => {
      const longValue = 'Ceci est une trÃ¨s longue idÃ©e d\'article qui dÃ©crit en dÃ©tail comment crÃ©er un jardin urbain avec des plantes comestibles et des fleurs ornementales dans un espace limitÃ©';
      let emittedValue = '';
      component.articleIdeaChange.subscribe(value => emittedValue = value);
      
      component.onArticleIdeaChange(longValue);
      
      expect(emittedValue).toBe(longValue);
    });

    it('devrait gÃ©rer les caractÃ¨res spÃ©ciaux', () => {
      const specialValue = 'Article avec Ã©Ã Ã§Ã¹ & "guillemets" et <balises>';
      let emittedValue = '';
      component.articleIdeaChange.subscribe(value => emittedValue = value);
      
      component.onArticleIdeaChange(specialValue);
      
      expect(emittedValue).toBe(specialValue);
    });

    it('devrait gÃ©rer les caractÃ¨res Unicode', () => {
      const unicodeValue = 'ðŸŒ± Jardinage avec plantes ðŸŒ¿ et fleurs ðŸŒ¸';
      let emittedValue = '';
      component.articleIdeaChange.subscribe(value => emittedValue = value);
      
      component.onArticleIdeaChange(unicodeValue);
      
      expect(emittedValue).toBe(unicodeValue);
    });

    it('devrait gÃ©rer plusieurs appels avec diffÃ©rentes valeurs', () => {
      const emittedValues: string[] = [];
      component.articleIdeaChange.subscribe(value => emittedValues.push(value));
      
      const values = ['PremiÃ¨re idÃ©e', 'DeuxiÃ¨me idÃ©e', 'TroisiÃ¨me idÃ©e'];
      values.forEach(value => {
        component.onArticleIdeaChange(value);
      });
      
      expect(emittedValues.length).toBe(3);
      expect(emittedValues[0]).toBe('PremiÃ¨re idÃ©e');
      expect(emittedValues[1]).toBe('DeuxiÃ¨me idÃ©e');
      expect(emittedValues[2]).toBe('TroisiÃ¨me idÃ©e');
    });

    it('devrait Ãªtre une mÃ©thode pure sans effets de bord', () => {
      const testValue = 'Test value';
      let generateEmitted = false;
      let changeEmitted = false;
      component.generate.subscribe(() => generateEmitted = true);
      component.articleIdeaChange.subscribe(() => changeEmitted = true);
      
      component.onArticleIdeaChange(testValue);
      
      expect(changeEmitted).toBe(true);
      expect(generateEmitted).toBe(false);
    });

    it('devrait prÃ©server la valeur exacte passÃ©e en paramÃ¨tre', () => {
      const exactValue = 'Valeur exacte avec espaces   et caractÃ¨res spÃ©ciaux Ã©Ã Ã§Ã¹';
      let emittedValue = '';
      component.articleIdeaChange.subscribe(value => emittedValue = value);
      
      component.onArticleIdeaChange(exactValue);
      
      expect(emittedValue).toBe(exactValue);
    });

    it('devrait gÃ©rer les chaÃ®nes contenant des URLs', () => {
      const urlValue = 'Article sur https://example.com/jardinage avec des liens';
      let emittedValue = '';
      component.articleIdeaChange.subscribe(value => emittedValue = value);
      
      component.onArticleIdeaChange(urlValue);
      
      expect(emittedValue).toBe(urlValue);
    });

    it('devrait gÃ©rer les chaÃ®nes contenant des emails', () => {
      const emailValue = 'Contact: jardinier@example.com pour plus d\'infos';
      let emittedValue = '';
      component.articleIdeaChange.subscribe(value => emittedValue = value);
      
      component.onArticleIdeaChange(emailValue);
      
      expect(emittedValue).toBe(emailValue);
    });

    it('devrait gÃ©rer les chaÃ®nes contenant des nombres', () => {
      const numberValue = 'Planter 15 graines Ã  2cm de profondeur';
      let emittedValue = '';
      component.articleIdeaChange.subscribe(value => emittedValue = value);
      
      component.onArticleIdeaChange(numberValue);
      
      expect(emittedValue).toBe(numberValue);
    });

    it('devrait gÃ©rer les chaÃ®nes contenant des mesures', () => {
      const measureValue = 'Arroser 2.5L d\'eau par mÂ² tous les 3-4 jours';
      let emittedValue = '';
      component.articleIdeaChange.subscribe(value => emittedValue = value);
      
      component.onArticleIdeaChange(measureValue);
      
      expect(emittedValue).toBe(measureValue);
    });
  });

  describe('IntÃ©gration des deux mÃ©thodes', () => {
    it('devrait pouvoir appeler les deux mÃ©thodes indÃ©pendamment', () => {
      let generateCount = 0;
      let changeCount = 0;
      let lastChangeValue = '';
      
      component.generate.subscribe(() => generateCount++);
      component.articleIdeaChange.subscribe(value => {
        changeCount++;
        lastChangeValue = value;
      });
      
      component.onGenerate();
      component.onArticleIdeaChange('Test idea');
      
      expect(generateCount).toBe(1);
      expect(changeCount).toBe(1);
      expect(lastChangeValue).toBe('Test idea');
    });

    it('devrait pouvoir appeler les deux mÃ©thodes dans n\'importe quel ordre', () => {
      let generateCount = 0;
      let changeCount = 0;
      
      component.generate.subscribe(() => generateCount++);
      component.articleIdeaChange.subscribe(() => changeCount++);
      
      component.onArticleIdeaChange('PremiÃ¨re idÃ©e');
      component.onGenerate();
      component.onArticleIdeaChange('DeuxiÃ¨me idÃ©e');
      
      expect(generateCount).toBe(1);
      expect(changeCount).toBe(2);
    });

    it('devrait maintenir l\'Ã©tat correct entre les appels', () => {
      let generateCount = 0;
      let changeCount = 0;
      
      component.generate.subscribe(() => generateCount++);
      component.articleIdeaChange.subscribe(() => changeCount++);
      
      component.onGenerate();
      component.onArticleIdeaChange('IdÃ©e aprÃ¨s gÃ©nÃ©ration');
      component.onGenerate();
      
      expect(generateCount).toBe(2);
      expect(changeCount).toBe(1);
    });
  });

  describe('Tests de robustesse', () => {
    it('devrait gÃ©rer les appels multiples rapides sur onGenerate', () => {
      let callCount = 0;
      component.generate.subscribe(() => callCount++);
      
      // Simuler des clics rapides
      for (let i = 0; i < 20; i++) {
        component.onGenerate();
      }
      
      expect(callCount).toBe(20);
    });

    it('devrait gÃ©rer les changements rapides sur onArticleIdeaChange', () => {
      const emittedValues: string[] = [];
      component.articleIdeaChange.subscribe(value => emittedValues.push(value));
      
      // Simuler des changements rapides de texte
      for (let i = 0; i < 50; i++) {
        component.onArticleIdeaChange(`Valeur ${i}`);
      }
      
      expect(emittedValues.length).toBe(50);
      expect(emittedValues[49]).toBe('Valeur 49');
    });

    it('devrait maintenir la cohÃ©rence des appels', () => {
      let generateCount = 0;
      let changeCount = 0;
      
      component.generate.subscribe(() => generateCount++);
      component.articleIdeaChange.subscribe(() => changeCount++);
      
      const expectedGenerateCount = 5;
      const expectedChangeCount = 10;
      
      // Appels alternÃ©s
      for (let i = 0; i < Math.max(expectedGenerateCount, expectedChangeCount); i++) {
        if (i < expectedGenerateCount) component.onGenerate();
        if (i < expectedChangeCount) component.onArticleIdeaChange(`Value ${i}`);
      }
      
      expect(generateCount).toBe(expectedGenerateCount);
      expect(changeCount).toBe(expectedChangeCount);
    });
  });

  describe('PropriÃ©tÃ©s du composant', () => {
    it('devrait avoir des valeurs par dÃ©faut correctes', () => {
      expect(component.articleIdea()).toBe('');
      expect(component.isGenerating()).toBe(false);
      expect(component.step()).toBe(0);
    });

    it('devrait avoir les outputs correctement dÃ©finis', () => {
      expect(component.generate).toBeDefined();
      expect(component.articleIdeaChange).toBeDefined();
    });
  });
});
