<div class="post-form-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>üìù √âdition des m√©tadonn√©es de l'article</mat-card-title>
      <mat-card-subtitle>Modifiez les informations de votre article</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="postForm" class="post-form">
        
        <!-- Titre -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Titre de l'article</mat-label>
          <input matInput formControlName="titre" placeholder="Entrez le titre de votre article">
          <mat-icon matSuffix>title</mat-icon>
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="saveField('titre')"
            [class.disabled-button]="!isTitreDirty()"
            title="Sauvegarder le titre">
            <mat-icon>save</mat-icon>
          </button>
        </mat-form-field>

        <!-- Description m√©t√©o -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description m√©t√©o</mat-label>
          <textarea 
            matInput 
            formControlName="description_meteo" 
            placeholder="Description des conditions m√©t√©orologiques"
            rows="3">
          </textarea>
          <mat-icon matSuffix>wb_sunny</mat-icon>
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="saveField('description_meteo')"
            [class.disabled-button]="!isDescriptionMeteoDirty()"
            title="Sauvegarder la description m√©t√©o">
            <mat-icon>save</mat-icon>
          </button>
        </mat-form-field>

        <!-- Phrase d'accroche -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Phrase d'accroche</mat-label>
          <textarea 
            matInput 
            formControlName="phrase_accroche" 
            placeholder="Phrase d'accroche attractive pour l'article"
            rows="2">
          </textarea>
          <mat-icon matSuffix>format_quote</mat-icon>
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="saveField('phrase_accroche')"
            [class.disabled-button]="!isPhraseAccrocheDirty()"
            title="Sauvegarder la phrase d'accroche">
            <mat-icon>save</mat-icon>
          </button>
        </mat-form-field>

        <!-- New href -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Lien de l'article (new_href)</mat-label>
          <input 
            matInput 
            formControlName="new_href" 
            placeholder="URL ou slug de l'article"
            type="url">
          <mat-icon matSuffix>link</mat-icon>
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="saveField('new_href')"
            [class.disabled-button]="!isNewHrefDirty()"
            title="Sauvegarder le lien">
            <mat-icon>save</mat-icon>
          </button>
        </mat-form-field>

        <!-- Citation -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Citation</mat-label>
          <textarea 
            matInput 
            formControlName="citation" 
            placeholder="Citation inspirante pour l'article"
            rows="2">
          </textarea>
          <mat-icon matSuffix>format_quote</mat-icon>
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="saveField('citation')"
            [class.disabled-button]="!isCitationDirty()"
            title="Sauvegarder la citation">
            <mat-icon>save</mat-icon>
          </button>
        </mat-form-field>

        <!-- Cat√©gorie -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Cat√©gorie</mat-label>
          <mat-select formControlName="categorie">
            <mat-option *ngFor="let category of categories" [value]="category.value">
              {{ category.label }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>category</mat-icon>
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="saveField('categorie')"
            [class.disabled-button]="!isCategorieDirty()"
            title="Sauvegarder la cat√©gorie">
            <mat-icon>save</mat-icon>
          </button>
        </mat-form-field>

      </form>
    </mat-card-content>
  </mat-card>

  <!-- Section Vid√©o -->
  <mat-card class="form-card" *ngIf="store.video()">
    <mat-card-header>
      <mat-card-title>üé• Lecteur vid√©o</mat-card-title>
      <mat-card-subtitle>Vid√©o associ√©e √† l'article</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="video-section">
        <!-- √âdition de l'URL vid√©o -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>URL de la vid√©o YouTube</mat-label>
          <input 
            matInput 
            [(ngModel)]="videoUrl" 
            placeholder="https://www.youtube.com/watch?v=..."
            type="url">
          <mat-icon matSuffix>video_library</mat-icon>
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="saveVideoUrl()"
            [class.disabled-button]="!isVideoUrlDirty()"
            title="Sauvegarder l'URL vid√©o">
            <mat-icon>save</mat-icon>
          </button>
        </mat-form-field>
        
        <!-- Aper√ßu de la vid√©o -->
        <div class="video-player" *ngIf="videoUrl && extractVideoId(videoUrl)">
          <!-- Contr√¥les de mode d'affichage -->
          <div class="video-controls">
            <button 
              mat-button 
              [color]="usePreviewMode ? 'primary' : 'accent'"
              (click)="toggleVideoMode()"
              class="mode-toggle-btn">
              <mat-icon>{{ usePreviewMode ? 'image' : 'play_circle' }}</mat-icon>
              {{ usePreviewMode ? 'Mode Pr√©visualisation' : 'Mode Lecteur' }}
            </button>
            <span class="mode-description">
              {{ usePreviewMode ? 'Aucun appel API - Image de pr√©visualisation' : 'Lecteur int√©gr√© (peut g√©n√©rer des appels)' }}
            </span>
          </div>

          <!-- Mode pr√©visualisation (recommand√©) -->
          <div class="video-preview" *ngIf="usePreviewMode">
            <div class="video-thumbnail" (click)="openVideoInNewTab()">
              <img 
                [src]="getYouTubeThumbnailUrl(extractVideoId(videoUrl)!)" 
                [alt]="'Aper√ßu de la vid√©o YouTube'"
                class="thumbnail-image">
              <div class="play-overlay">
                <mat-icon class="play-icon">play_circle_filled</mat-icon>
                <p>Cliquer pour ouvrir sur YouTube</p>
              </div>
            </div>
          </div>

          <!-- Mode lecteur int√©gr√© -->
          <div class="video-iframe" *ngIf="!usePreviewMode">
            <!-- Indicateur de chargement -->
            <div class="video-loading" *ngIf="videoLoading">
              <mat-icon>refresh</mat-icon>
              <p>Chargement de la vid√©o...</p>
              <button mat-button color="warn" (click)="forceStopLoading()" class="stop-loading-btn">
                <mat-icon>stop</mat-icon>
                Arr√™ter le chargement
              </button>
            </div>
            
            <!-- Lecteur vid√©o -->
            <iframe 
              *ngIf="!videoLoading && !videoError"
              [src]="getYouTubeEmbedUrl(extractVideoId(videoUrl)!)"
              width="100%" 
              height="315" 
              frameborder="0" 
              allowfullscreen
              sandbox="allow-scripts allow-same-origin allow-presentation"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              (load)="onVideoLoad()"
              (error)="onVideoError()"
              style="display: block; border: none;">
            </iframe>
            
            <!-- Message d'erreur -->
            <div class="video-error" *ngIf="videoError">
              <mat-icon>error</mat-icon>
              <p>Erreur lors du chargement de la vid√©o. Veuillez v√©rifier l'URL.</p>
              <button mat-button color="primary" (click)="retryVideo()">
                <mat-icon>refresh</mat-icon>
                R√©essayer
              </button>
            </div>
          </div>
        </div>

        <!-- Message si URL invalide -->
        <div class="video-error" *ngIf="videoUrl && !extractVideoId(videoUrl)">
          <mat-icon>warning</mat-icon>
          <p>URL YouTube invalide. Veuillez utiliser un format comme: https://www.youtube.com/watch?v=VIDEO_ID</p>
        </div>

        <div class="video-actions">
          <button mat-raised-button color="warn" (click)="removeVideo()" *ngIf="videoUrl">
            <mat-icon>delete</mat-icon>
            Supprimer la vid√©o
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Section FAQ -->
  <mat-card class="form-card" *ngIf="store.faq().length > 0">
    <mat-card-header>
      <mat-card-title>‚ùì Questions fr√©quentes (FAQ)</mat-card-title>
      <mat-card-subtitle>{{ store.faq().length }} question(s) disponible(s)</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <mat-accordion class="faq-accordion">
        <mat-expansion-panel *ngFor="let faqItem of store.faq(); let i = index" class="faq-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>help_outline</mat-icon>
              Question {{ i + 1 }}
            </mat-panel-title>
            <mat-panel-description>
              {{ faqItem.question | slice:0:50 }}{{ faqItem.question.length > 50 ? '...' : '' }}
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="faq-content">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Question</mat-label>
              <textarea 
                matInput 
                [(ngModel)]="faqItem.question"
                rows="2"
                placeholder="Question FAQ">
              </textarea>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>R√©ponse</mat-label>
              <textarea 
                matInput 
                [(ngModel)]="faqItem.response"
                rows="4"
                placeholder="R√©ponse d√©taill√©e">
              </textarea>
            </mat-form-field>

            <div class="faq-actions">
              <button mat-raised-button color="primary" (click)="saveFaqItem(i)">
                <mat-icon>save</mat-icon>
                Sauvegarder
              </button>
              <button mat-button color="warn" (click)="deleteFaqItem(i)">
                <mat-icon>delete</mat-icon>
                Supprimer
              </button>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>

      <div class="faq-global-actions">
        <button mat-raised-button color="accent" (click)="addNewFaqItem()">
          <mat-icon>add</mat-icon>
          Ajouter une question
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Images internes -->
  <mat-card class="form-card" *ngIf="store.internalImages().length > 0">
    <mat-card-header>
      <mat-card-title>üñºÔ∏è Images internes</mat-card-title>
      <mat-card-subtitle>G√©rez les images associ√©es aux chapitres</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <mat-accordion multi>
        <mat-expansion-panel *ngFor="let image of store.internalImages(); let i = index" class="image-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>image</mat-icon>
              Chapitre {{ image.chapitre_id }} - {{ image.chapitre_key_word }}
            </mat-panel-title>
            <mat-panel-description>
              {{ image.explanation_word }}
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="image-form">
            <div class="image-preview" *ngIf="image.url_Image">
              <img [src]="image.url_Image" [alt]="image.chapitre_key_word" class="preview-img">
            </div>
            
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Mot-cl√© du chapitre</mat-label>
              <input matInput [(ngModel)]="image.chapitre_key_word" (ngModelChange)="updateInternalImage(i, 'chapitre_key_word', $event)">
              <mat-icon matSuffix>label</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>URL de l'image</mat-label>
              <input matInput [(ngModel)]="image.url_Image" (ngModelChange)="updateInternalImage(i, 'url_Image', $event)">
              <mat-icon matSuffix>link</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Explication</mat-label>
              <textarea matInput [(ngModel)]="image.explanation_word" (ngModelChange)="updateInternalImage(i, 'explanation_word', $event)" rows="2"></textarea>
              <mat-icon matSuffix>description</mat-icon>
            </mat-form-field>

            <div class="image-actions">
              <button mat-raised-button color="warn" (click)="removeInternalImage(i)">
                <mat-icon>delete</mat-icon>
                Supprimer l'image
              </button>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </mat-card-content>
  </mat-card>

</div>
